# Dubbo介绍


了解一个服务框架最好的办法就是去看它的官方文档，因为我们所有的知识点都是来源于[官方文档](https://cn.dubbo.apache.org/zh-cn/overview/home/)

## 1 什么是Dubbo？

![工作原理图](/posts/dubbo/architecture.png)

从抽象架构来看，可以将 Dubbo 分为两层：

- **服务治理抽象控制面**
- **Dubbo数据面**

**服务治理抽象控制面**，不是特指具体某个组件，而是对 Dubbo治理体系的一种抽象表达。它包括如注册中心、admin控制台、流量管控策略等服务。

**Dubbo数据面**，代表集群部署的所有 Dubbo 进程，进程之间通过 RPC协议实现数据交换，Dubbo定义了微服务中应用的开发与调用的规范，并负责完成数据传输的编解码工作（如，服务消费者和提供者，用来发起和接收业务调用）。

### 1.1 Dubbo服务治理

![服务治理](/posts/dubbo/governance.png)

#### 1.1.1 什么是服务治理？

服务治理就是，在微服务集群环境下，解决 无状态服务节点动态变化、外部化配置、日志跟踪、可观测性、流量管理、高可用性、数据一致性等一系列问题。

#### 1.1.2 核心服务治理功能

- **地址发现**

Dubbo服务发现，默认提供 Nacos、Zookeeper、Consul等注册中心适配，与 Spring Cloud、Kubernetes Service模型打通，并支持自定义扩展。

- **负载均衡**

Dubbo默认提供 加权随机、加权轮询、最少活跃请求数优先、最短响应时间优先、一致性哈希和自适应负载等策略。

- **流量路由**

Dubbo支持通过一系列流量规则控制服务调用的流量分布和行为。

基于这些规则可以实现基于权重的比例流量分发、灰度验证、金丝雀发布、按请求参数的路由、同区域优先、超时配置、重试和限流降级等能力。

- **链路追踪**

Dubbo通过适配 OpenTelemety 提供了对 Tracing 全链路追踪支持，也有社区提供对Dubbo的适配，比如Skywalking、Zipkin。

- **可观测性**

Dubbo实例通过 Prometheus等上报 QPS、RT、请求次数、成功率、异常次数等可观测指标帮助用户了解服务运行状态，通过接入 Grafana、Admin控制台帮助实现指标可视化展示。

Admin控制台完成集群的几乎所有的管控工作。

- 查询服务、应用或机器状态
- 创建项目、服务测试、文档管理等
- 查看集群实时流量、定位异常问题等
- 流量比例分发、参数路由等流量管控规则下发

另外，Dubbo服务治理生态还提供了对 **API网关**、**限流降级**、**数据一致性**、**认证鉴权**等场景的适配支持。

### 1.2 Dubbo数据面

从数据面角度来看，

- Dubbo作为 服务开发框架，它约束了微服务的定义、开发与调用的规范，并且定义了服务治理的流程和适配模式。
- Dubbo作为 RPC通信协议实现，它解决了服务间数据传输的编解码问题。

![数据面](/posts/dubbo/framework1.png)

#### 1.2.1 服务开发框架

微服务的目标：构建足够小、自包含、独立演进、可随时部署运行的分布式应用程序。

微服务的分布式特性，使得应用间的依赖、网络交互、数据传输变得更频繁。这就会衍生出一些问题，比如，应用需要定义、暴露或调用RPC服务，那么这些服务如何定义？如何与应用的开发框架结合？服务的调用行文如何控制？

Dubbo服务开发框架的含义，它在微服务应用开发框架之上抽象了一套RPC服务定义、暴露、调用和治理的编程范式。

![Dubbo服务开发框架](/posts/dubbo/framework2.png)

Dubbo作为服务开发框架包含的具体内容：

- **RPC 服务定义、开发范式**，比如支持IDL定义服务或Java Interface定义服务。
- **RPC 服务发布与调用 API**，支持 同步、异步、Reactive Streaming等服务调用编程模式，还支持请求上下文API、设置超时时间等。
- **服务治理策略、流程与适配方式等**

#### 1.2.2 RPC 通信协议实现

Dubbo从设计上不绑定任何一款特定通信协议，几乎所有主流通信协议都支持（HTTP/2、REST、gRPC、JsonRPC、Thrift、Hessian2）。这种Protocol设计模式给构建微服务带来最大的灵活性。

另外，Dubbo Protocol支持扩展，可以将内部私有协议适配到Dubbo上。

Dubbo还支持多协议暴露，即单个端口上暴露多个协议，Dubbo Server能够自动识别并确保请求被正确处理。也可以将同一个RPC服务发布到不同端口（协议），为不同技术栈的调用方服务。

Dubbo2 和 Triple（兼容 gRPC）两个协议，可以满足对高性能通信的要求。

- Dubbo2协议，在TCP传输层协议之上设计的二进制通信协议。
- Triple协议，基于HTTP/2之上构建的支持流模式的通信协议，并且支持 gRPC。

![protocol设计模式](/posts/dubbo/protocol.png)

## 2 Dubbo的优势有哪些？

### 2.1 快速易用

- 多语言SDK，比如，`dubbo-spring-boot-starter`。
- 任意通信协议，多协议支持让用户选型。
- 项目脚手架加速微服务开发

### 2.2 超高性能

- 高性能数据传输，内置支持 Dubbo2、Triple 两款高性能通信协议。
- 可构建伸缩的微服务集群。
- 智能化流量调度，
  - 自适应负载均衡，是从消费者视角考虑如何将请求分配到当前具有最优处理能力的机器实例。Dubbo3引入两种负载均衡算法，
    - 一种是基于公平性的单纯`P2C`算法，
    - 另一种是基于自适应方法`adaptive`，其试图自适应的衡量 provider端机器的吞吐能力，然后将流量尽可能分配到吞吐能力高的机器上，以提升系统性能。
  - 自适应限流，与负载均衡运行在消费者端不同的是，限流功能运行在提供者端。其作用是限制提供端实例处理并发任务时的最大数量。理论上，服务端机器的处理能力是存在上限的，因此当并发请求量达到或接近上限时，拒绝掉一部分请求反而是更好的选择。相比于人为提前设置静态最大并发值，自适应限流算法可以动态调整服务端机器的最大并发值，使其可以在保证机器不过载的前提下，尽可能多的处理接收到的请求。

### 2.3 服务治理

像之前提到过的服务治理的功能就不多赘述，还有下面的作用。

#### 2.3.1 流量管控

在地址发现和负载均衡机制之外，Dubbo 的流量管控规则可以控制服务间的流量走向和 API 调用，基于这些规则可以实现动态地调整服务行为，如超时时间、重试次数、限流参数等。通过控制流量分布可以实现 A/B 测试、金丝雀发布、多版本按比例流量分配、条件匹配路由、黑白名单等，提高系统稳定性。

## 3 认清 Dubbo

在学一个新知识之前，一定要搞清楚它的定位，下面我们来了解下 Dubbo 与 gRPC、Spring Cloud、Istio的关系。

### 3.1 Dubbo 与 Spring Cloud

![dubbo-springcloud](/posts/dubbo/dubbo-springcloud.png)

从图中我们可以看出，二者其实很相似，都是在整个架构中担任服务治理的角色。它们都侧重于在分布式系统中对问题模式的抽象（如服务发现、负载均衡、动态配置等）。

Spring Cloud存在的问题：

- 只提供抽象模式定义，不提供官方稳定实现。小体系开发团队只能寻求 Netflix、Alibaba、Azure等大厂商的实现套件，而不同厂商的实现的完善度、稳定性、活跃度都各异。
- 在流量管控方面如负载均衡、流量路由等服务治理能力上欠缺。
- 其编程模型和主要依赖于基于HTTP通信，当你的微服务体系结构深度依赖于HTTP和RESTful API时，与那些主要使用其他RPC协议（如 gRPC）的系统集成会有障碍。

### 3.2 Dubbo 与 gRPC

- gRPC是一款RPC框架，Google推出它的核心目的是定义云原生时代的 rpc通信规范与标准实现。
- Dubbo则是一款微服务开发框架。

![dubbo-grpc](/posts/dubbo/dubbo-grpc.png)

Dubbo不绑定特定的通信协议，并且它支持在微服务中选用 gRPC 通信。

### 3.3 Dubbo 与 Istio

Istio 是 Service Mesh 的开源代表实现，而 Service Mesh 是 Kubernetes体系下的一种微服务架构。它从部署架构上分为数据面和控制面（和Dubbo类似），主要不同是，

- 数据面，istio引入 Sidecar 实现了对服务流量的透明拦截。
- 控制面，将抽象的服务治理中心聚合为一个具有统一实现的具体组件，并与Kubernetes无缝适配。

Dubbo已经实现了对 istio 体系的全面接入，通过 istio控制面来治理 Dubbo服务。在数据面部署上，dubbo通过支持无代理的 Proxyless模式来解决 sidecar引入的复杂性和性能问题。

![mix-mesh](/posts/dubbo/mix-mesh.png)

从数据面角度，Dubbo支持 Proxy模式 和 Proxyless模式来进行开发和部署，前者 Dubbo 和 Envoy 一起部署，Dubbo作为框架&协议通信组件存在，流量管控交由Envoy和istio控制面来实现。后者，Dubbo进程保持独立部署，通过标准 xDS协议 直接接入 istio等控制面组件。

从控制面角度，Dubbo可接入原生 istio标准控制面和规则体系。

